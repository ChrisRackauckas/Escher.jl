<script>

function teelog(x) {
    console.log(x)
    return x
}

(function () {

    var socket_url = function (suffix) {
        var loc = window.location, new_uri;
        if (loc.protocol === "https:") {
            new_uri = "wss:";
        } else {
            new_uri = "ws:";
        }
        new_uri += "//" + loc.host;
        new_uri += "/socket/" + suffix;
        return new_uri;
    }

    var commands = {
        patch: function (cmd) {
            Escherd.applyPatch(cmd.id, cmd.data)
        },
        import: function (cmd) {
            var ln = document.createElement("link")
            ln.rel = "import"
            ln.href = cmd.data
            document.head.appendChild(ln)
        },
        log: function (cmd) {
            console.log(cmd)
        },
        message: function (msg) {
            this.websocket.send(JSON.stringify(msg))
        }
    }


    function Escherd(suffix) {
        this.websocket = null
        var w = window.innerWidth,
            h = window.innerHeight,
            url = socket_url(suffix) + "?w=" + w + "&h=" + h

        var ws = new WebSocket(url)

        var self = this
        ws.onmessage = function (msg) {
            var cmd = JSON.parse(msg.data),
                f = commands[cmd.command]
            if (!f) {
                console.log("Invalid command", cmd.command, "invoked")
            } else {
                f.call(self, cmd)
            }
        }
        ws.onerror = function (e) {
            console.log("Error in web socket connection", e)
        }
        this.websocket = ws

        window.addEventListener("resize", function (ev) {
            // TODO: Throttle
            commands.message.call(self,
                { command: "window-size",
                  data: [ window.innerWidth, window.innerHeight ]
                }
            )
        })


        var closeHandler = function () {
            commands.message.call(self,
                {command: "window-kill", data: null})
            // prevent firing twice
            window.removeEventListener("beforeunload", closeHandler)
        }

        window.addEventListener("beforeunload", closeHandler)

        document.addEventListener("signal-transport", function (ev) {
                commands["message"].call(self, (teelog({
                    command: "signal-update",
                    data: {
                        signalId: ev.detail.signalId,
                        value: ev.detail.value
                    }
                })))
                ev.stopPropagation()
        })
    }

    // Store for patches of nodes as yet uncreated
    Escherd.patches = {}
    Escherd.applyPatch = function (id, patch) {
        if (typeof(Escherd.patches[id]) === "undefined") {
            Escherd.patches[id] = []
        }
        if (typeof(escher_subtrees.ready[id]) !== "undefined") {
            escher_subtrees.ready[id].applyPatch(patch)
        } else if (typeof(escher_subtrees.destroyed[id]) !== "undefined") {
            console.log("Patch received for a previously destroyed subtree. This is why we can't have good things.")
        } else {
            Escherd.patches[id].push(patch)
        }
    }

    Escherd.addSubtree = function (id, node) {
        delete escher_subtrees.destroyed[id]
        escher_subtrees.ready[id] = node
        if (typeof(Escherd.patches[id]) !== "undefined") {
            for (var i=0, l=Escherd.patches[id].length;
                    i < l; i++) {
                node.applyPatch(Escherd.patches[id][i])
            }
        }
    }

    Escherd.removeSubtree = function (id) {
        delete escher_subtrees.ready[id]
        escher_subtrees.destroyed[id] = true
    }

    window.Escherd = Escherd
    window.escher_subtrees = {ready: {}, destroyed: {}}
})();
</script>

<polymer-element
    name="signal-container">

<template>
    <content></content>
</template>

<script>

    Polymer("signal-container", {
        id: "",
        vnode: null,
        domReady: function () {
            // Starts with Escher.empty.
            this.vnode = new Patchwork.Node(this.id, {t: "div"}, this)
            Escherd.addSubtree(this.id, this.vnode)
        },
        idChanged: function (a, b) {
            if (a !== "") {
                Escherd.removeSubtree(a)
                Escherd.addSubtree(b, this.vnode)
            }
        }
    })
</script>

</polymer-element>
